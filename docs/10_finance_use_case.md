# 第10篇：金融场景实战 —— 用 blockcell 监控股票和加密货币

> 系列文章：《blockcell 开源项目深度解析》第 10/14 篇

---

## 为什么金融场景适合 AI 智能体

金融数据有几个特点，非常适合 AI 智能体处理：

1. **数据量大**：每天成千上万条行情数据，人工处理效率低
2. **实时性强**：价格每秒变化，需要持续监控
3. **多维度分析**：技术面 + 基本面 + 消息面，需要综合判断
4. **重复性高**：每天的分析流程基本固定，适合自动化

blockcell 内置了完整的金融数据工具链，本篇通过实际场景演示如何使用。

---

## 数据源概览

blockcell 的金融数据工具支持多个数据源，大多数**免费无需 API Key**：

| 数据类型 | 数据源 | 是否免费 |
|---------|--------|---------|
| A股/港股实时行情 | 东方财富 | ✅ 免费 |
| A股历史 K 线 | 东方财富 | ✅ 免费 |
| 美股行情 | Yahoo Finance | ✅ 免费 |
| 美股历史 | Alpha Vantage | 需 Key（免费版） |
| 加密货币价格 | CoinGecko | ✅ 免费 |
| 加密货币历史 | CoinGecko | ✅ 免费 |
| 国债收益率 | 东方财富 | ✅ 免费 |
| 外汇汇率 | open.er-api.com | ✅ 免费 |
| 链上数据 | 公共 RPC 节点 | ✅ 免费 |

---

## 场景一：查询实时股价

最简单的用法：

```
你: 帮我查一下茅台今天的股价
```

AI 会自动识别"茅台"对应代码 `600519`，调用东方财富 API：

```
茅台（600519）实时行情：
当前价格：1,680.00 元
涨跌幅：+1.23%（+20.40 元）
成交量：1,234,567 手
成交额：20.74 亿元
市盈率（PE）：28.5
市净率（PB）：8.2
52周最高：1,850.00
52周最低：1,420.00
```

### 常用股票代码

blockcell 内置了常见股票的代码映射：

| 股票名称 | 代码 | 市场 |
|---------|------|------|
| 贵州茅台 | 600519 | A股沪市 |
| 中国平安 | 601318 | A股沪市 |
| 宁德时代 | 300750 | A股深市 |
| 腾讯控股 | 00700 | 港股 |
| 阿里巴巴 | 09988 | 港股 |
| 苹果 | AAPL | 美股 |
| 英伟达 | NVDA | 美股 |

---

## 场景二：K 线分析与技术指标

```
你: 帮我分析茅台最近三个月的走势，计算 MA20 和 MACD
```

AI 的执行过程：

```
1. finance_api stock_history symbol=600519 period=3mo
   → 获取 60 个交易日的 OHLCV 数据

2. 本地计算技术指标：
   MA20 = 最近20日收盘价均值
   MACD = EMA12 - EMA26
   Signal = MACD的9日EMA
   Histogram = MACD - Signal

3. chart_generate line 画出价格走势 + MA20
4. chart_generate bar 画出 MACD 柱状图
```

输出示例：

```
茅台（600519）近3个月技术分析：

价格走势：
- 当前价格：1,680 元
- 3个月涨跌：+8.5%
- 最高：1,780 元（2025-01-15）
- 最低：1,520 元（2024-11-20）

MA 均线：
- MA5：1,672（短期支撑）
- MA20：1,645（中期支撑）
- MA60：1,598（长期支撑）
当前价格在三条均线上方，趋势偏多。

MACD（12,26,9）：
- MACD：+12.5
- Signal：+8.3
- Histogram：+4.2（正值，多头）
MACD 金叉后持续走强，短期动能充足。

综合判断：技术面偏强，但需关注 1,700 阻力位。

[已生成图表：~/Desktop/maotai_analysis.png]
```

---

## 场景三：设置价格告警

```
你: 帮我设置一个告警：
    茅台跌破 1600 时，通过 Telegram 发消息给我
    比特币涨过 10 万美元时，也发消息
```

AI 会创建两个告警规则：

**告警1：茅台跌破 1600**
```json
{
  "name": "茅台跌破1600",
  "check_interval_secs": 300,
  "condition": {
    "tool": "finance_api",
    "params": {"action": "stock_quote", "symbol": "600519"},
    "field": "price",
    "operator": "lt",
    "threshold": 1600
  },
  "on_trigger": [{
    "tool": "notification",
    "params": {
      "channel": "telegram",
      "message": "⚠️ 茅台跌破1600！当前价格：{value} 元"
    }
  }]
}
```

**告警2：比特币涨过 10 万美元**
```json
{
  "name": "BTC破10万",
  "check_interval_secs": 60,
  "condition": {
    "tool": "finance_api",
    "params": {"action": "crypto_price", "symbol": "bitcoin"},
    "field": "price_usd",
    "operator": "gt",
    "threshold": 100000
  },
  "on_trigger": [{
    "tool": "notification",
    "params": {
      "channel": "telegram",
      "message": "🚀 比特币突破10万美元！当前价格：${value}"
    }
  }]
}
```

告警规则持久化保存，重启后自动恢复。

---

## 场景四：每日金融日报

这是 blockcell 内置的 `daily_finance_report` 技能，可以自动生成每日金融日报。

```
你: 帮我生成今天的金融日报
```

日报内容包括：

```
📊 金融日报 2025-02-18

【大盘行情】
沪指：3,350.25（+0.85%）
深指：10,890.50（+1.20%）
创业板：2,180.30（+1.50%）

【资金流向】
北向资金：净流入 45.6 亿元
融资余额：15,234 亿元（+23 亿）

【热点板块】
涨幅前三：AI算力（+3.2%）、机器人（+2.8%）、半导体（+2.1%）
跌幅前三：房地产（-1.5%）、银行（-0.8%）、煤炭（-0.5%）

【自选股】
茅台（600519）：1,680（+1.23%）✅
平安（601318）：42.50（-0.35%）
宁德（300750）：185.20（+2.10%）✅

【加密市场】
BTC：$68,500（+2.3%）
ETH：$3,850（+1.8%）
市场情绪：贪婪（指数：72）

【今日关注】
- 美联储 FOMC 会议纪要将于北京时间 03:00 公布
- A股两会前夕，政策预期升温
```

### 设置定时发送

```
你: 帮我设置每天早上 8:30 自动生成金融日报，
    通过 Telegram 发给我
```

AI 会创建一个 Cron 任务：

```bash
blockcell cron list
# daily_report  30 8 * * *  ✓ 每天 08:30
```

---

## 场景五：加密货币链上监控

blockcell 支持直接查询区块链数据：

```
你: 帮我查一下以太坊上 Uniswap V3 的 ETH/USDC 池子的当前价格
```

```
1. blockchain_rpc eth_call
   合约：0x88e6A0c2dDD26FEEb64F039a2c41296FcB3f5640
   方法：slot0()
   链：ethereum

2. 解码返回值，计算价格
   当前 ETH 价格：$3,852.40
   池子流动性：$1.2B
   24h 交易量：$450M
```

### 监控巨鲸地址

```
你: 帮我监控这个地址的 USDT 余额：
    0x742d35Cc6634C0532925a3b844Bc454e4438f44e
    余额超过 1000 万时告诉我
```

AI 会创建一个链上监控告警：

```json
{
  "name": "巨鲸USDT监控",
  "condition": {
    "tool": "blockchain_rpc",
    "params": {
      "action": "eth_call",
      "contract": "0xdAC17F958D2ee523a2206206994597C13D831ec7",
      "function_sig": "balanceOf(address)",
      "args": ["0x742d35Cc6634C0532925a3b844Bc454e4438f44e"]
    },
    "operator": "gt",
    "threshold": 10000000000000
  }
}
```

---

## 场景六：投资组合分析

```
你: 我持有以下股票，帮我分析一下投资组合：
    茅台 10 股，平安 100 股，宁德 50 股，
    BTC 0.5 个，ETH 2 个
```

AI 会：
1. 查询所有资产的当前价格
2. 计算总市值和各资产占比
3. 分析行业集中度
4. 计算组合的整体涨跌幅
5. 生成饼图展示资产配置

```
投资组合分析报告：

总市值：约 ¥ 285,000

资产配置：
┌─────────────┬──────────┬──────────┬──────────┐
│ 资产        │ 数量     │ 当前价   │ 市值     │
├─────────────┼──────────┼──────────┼──────────┤
│ 茅台        │ 10 股    │ 1,680    │ 16,800   │
│ 平安        │ 100 股   │ 42.50    │ 4,250    │
│ 宁德        │ 50 股    │ 185.20   │ 9,260    │
│ BTC         │ 0.5 个   │ $68,500  │ ≈248,000 │
│ ETH         │ 2 个     │ $3,850   │ ≈55,700  │
└─────────────┴──────────┴──────────┴──────────┘

风险提示：
- 加密货币占比 87%，波动风险较高
- A股持仓较少，建议适当增加
```

---

## 场景七：实时行情订阅

对于需要毫秒级实时数据的场景，可以使用 WebSocket 订阅：

```
你: 帮我订阅币安的 BTC/USDT 实时成交数据
```

```
1. stream_subscribe subscribe
   url=wss://stream.binance.com:9443/ws/btcusdt@trade
   name=btc_trade

2. 每隔 5 秒读取最新数据
   stream_subscribe read name=btc_trade count=10

3. 分析最近 10 笔成交：
   最新价：$68,523.50
   买卖比：6:4（买盘略强）
   最大单笔：2.3 BTC
```

订阅会持久化，重启后自动恢复连接。

---

## 完整的量化分析工作流

把上面的场景组合起来，可以构建一个完整的量化分析工作流：

```
每天 8:30：
1. 生成金融日报（大盘 + 热点 + 自选股）
2. 检查告警规则（价格突破、异常波动）
3. 更新持仓分析（盈亏统计）
4. 发送 Telegram 日报

每小时：
5. 检查链上巨鲸动向
6. 监控 DeFi 清算风险
7. 更新技术指标

实时：
8. WebSocket 订阅关键价格
9. 触发告警时立即通知
```

这整套工作流可以用 blockcell 的 Cron + 告警 + 渠道系统完全自动化。

---

## 小结

blockcell 的金融场景能力：

- **A股/港股/美股**：东方财富 + Yahoo Finance，大多数免费
- **加密货币**：CoinGecko + 交易所 API + 链上 RPC
- **技术分析**：自动计算 MA/MACD/RSI/KDJ/BOLL
- **告警系统**：价格突破、涨跌幅、链上事件
- **实时订阅**：WebSocket 行情流，持久化重连
- **自动报告**：定时生成日报，推送到 Telegram

对于量化交易者、投资者或者只是想跟踪市场的普通用户，blockcell 都能提供强大的自动化支持。
---

*上一篇：[自我进化 —— AI 如何自动写代码升级自己](./09_self_evolution.md)*
*下一篇：[子智能体与任务并发 —— 让 AI 同时做多件事](./11_subagents.md)*

*项目地址：https://github.com/blockcell-labs/blockcell*
*官网：https://blockcell.dev*
