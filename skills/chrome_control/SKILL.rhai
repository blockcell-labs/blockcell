// æµè§ˆå™¨è‡ªåŠ¨åŒ–ç¼–æ’è„šæœ¬ (Chrome Control Orchestration)
//
// é¢„æ³¨å…¥å˜é‡:
//   user_input   â€” ç”¨æˆ·åŸå§‹è¾“å…¥æ–‡æœ¬
//   url          â€” ç›®æ ‡ URL (å¯é€‰)
//   search_term  â€” æœç´¢å…³é”®è¯ (å¯é€‰)
//   search_engine â€” æœç´¢å¼•æ“ (å¯é€‰, é»˜è®¤ "baidu")

// === Step 1: è§£æå‚æ•° ===
let engine = if search_engine != () { search_engine } else { "baidu" };

// æœç´¢å¼•æ“é…ç½®
let engine_urls = #{
    baidu: "https://www.baidu.com",
    google: "https://www.google.com",
    bing: "https://www.bing.com"
};

let engine_selectors = #{
    baidu: "#kw",
    google: "textarea[name=\"q\"]",
    bing: "#sb_form_q"
};

log("ğŸŒ [æµè§ˆå™¨] å¼€å§‹æµè§ˆå™¨è‡ªåŠ¨åŒ–");

// === Step 2: ç¡®å®šç›®æ ‡ URL ===
let target_url = if url != () && url != "" {
    url
} else {
    let u = engine_urls[engine];
    if u != () { u } else { "https://www.baidu.com" }
};

log("ğŸŒ [æµè§ˆå™¨] ç›®æ ‡: " + target_url);

// === Step 3: æ‰“å¼€æµè§ˆå™¨ ===
let open_result = call_tool("chrome_control", #{
    action: "open",
    url: target_url
});

if is_error(open_result) {
    let err = get_field(open_result, "error");
    log_warn("ğŸŒ [æµè§ˆå™¨] æ‰“å¼€å¤±è´¥: " + err);
    set_output(#{
        success: false,
        error: "æ— æ³•æ‰“å¼€ Chrome æµè§ˆå™¨: " + err,
        suggestion: "è¯·ç¡®ä¿å·²å®‰è£… Google Chrome å¹¶æˆæƒè¾…åŠ©åŠŸèƒ½æƒé™"
    });
    return;
}

// ç­‰å¾…é¡µé¢åŠ è½½
call_tool("chrome_control", #{
    action: "wait",
    amount: 1500
});

log("ğŸŒ [æµè§ˆå™¨] é¡µé¢å·²æ‰“å¼€");

// === Step 4: å¦‚æœæœ‰æœç´¢å…³é”®è¯ï¼Œæ‰§è¡Œæœç´¢ ===
if search_term != () && search_term != "" {
    log("ğŸŒ [æµè§ˆå™¨] æœç´¢: " + search_term);

    // è·å–æœç´¢æ¡†é€‰æ‹©å™¨
    let selector = engine_selectors[engine];
    if selector == () {
        selector = "#kw";  // é»˜è®¤ç™¾åº¦
    }

    // ç‚¹å‡»æœç´¢æ¡†
    let click_result = call_tool("chrome_control", #{
        action: "click",
        selector: selector
    });

    if is_error(click_result) {
        log_warn("ğŸŒ [æµè§ˆå™¨] æœç´¢æ¡†ç‚¹å‡»å¤±è´¥ï¼Œå°è¯•ç›´æ¥è¾“å…¥");
    }

    // çŸ­æš‚ç­‰å¾…
    call_tool("chrome_control", #{
        action: "wait",
        amount: 300
    });

    // è¾“å…¥æœç´¢å…³é”®è¯
    let type_result = call_tool("chrome_control", #{
        action: "type",
        text: search_term
    });

    if is_error(type_result) {
        log_warn("ğŸŒ [æµè§ˆå™¨] è¾“å…¥å¤±è´¥: " + get_field(type_result, "error"));
        set_output(#{
            success: false,
            error: "æ— æ³•åœ¨æœç´¢æ¡†ä¸­è¾“å…¥æ–‡å­—",
            suggestion: "è¯·æ£€æŸ¥è¾…åŠ©åŠŸèƒ½æƒé™"
        });
        return;
    }

    // æŒ‰å›è½¦æœç´¢
    call_tool("chrome_control", #{
        action: "press_key",
        text: "return"
    });

    // ç­‰å¾…æœç´¢ç»“æœ
    call_tool("chrome_control", #{
        action: "wait",
        amount: 2000
    });

    log("ğŸŒ [æµè§ˆå™¨] æœç´¢å®Œæˆï¼Œè¯»å–ç»“æœ");

    // è¯»å–æœç´¢ç»“æœ
    let read_result = call_tool("chrome_control", #{
        action: "read"
    });

    let page_content = if !is_error(read_result) {
        get_field(read_result, "content")
    } else {
        #{}
    };

    set_output(#{
        success: true,
        action: "search",
        engine: engine,
        url: target_url,
        search_term: search_term,
        page_content: page_content,
        steps: [
            "æ‰“å¼€ " + target_url,
            "è¾“å…¥æœç´¢è¯: " + search_term,
            "æ‰§è¡Œæœç´¢",
            "è·å–æœç´¢ç»“æœ"
        ]
    });
} else {
    // ä»…æ‰“å¼€é¡µé¢ï¼Œè¯»å–å†…å®¹
    let read_result = call_tool("chrome_control", #{
        action: "read"
    });

    let page_content = if !is_error(read_result) {
        get_field(read_result, "content")
    } else {
        #{}
    };

    set_output(#{
        success: true,
        action: "open",
        url: target_url,
        page_content: page_content,
        steps: [
            "æ‰“å¼€ " + target_url,
            "é¡µé¢åŠ è½½å®Œæˆ"
        ]
    });
}
