// æ‹ç…§æŠ€èƒ½ç¼–æ’è„šæœ¬ (Camera Capture Orchestration)
//
// å¯ç”¨å‡½æ•°:
//   call_tool(name, params)  â€” è°ƒç”¨å·¥å…·ï¼Œè¿”å›ç»“æœ Map
//   is_error(result)         â€” æ£€æŸ¥ç»“æœæ˜¯å¦ä¸ºé”™è¯¯
//   get_field(map, key)      â€” å®‰å…¨è·å– Map å­—æ®µ
//   set_output(value)        â€” è®¾ç½®æœ€ç»ˆè¾“å‡º
//   log(msg)                 â€” è®°å½•æ—¥å¿—
//   log_warn(msg)            â€” è®°å½•è­¦å‘Š
//   to_json(value)           â€” è½¬ä¸º JSON å­—ç¬¦ä¸²
//   timestamp()              â€” å½“å‰æ—¶é—´æˆ³
//
// é¢„æ³¨å…¥å˜é‡:
//   user_input  â€” ç”¨æˆ·åŸå§‹è¾“å…¥æ–‡æœ¬
//   device      â€” æ‘„åƒå¤´ç´¢å¼• (å¯é€‰, é»˜è®¤ "0")
//   format      â€” å›¾ç‰‡æ ¼å¼ (å¯é€‰, é»˜è®¤ "jpg")
//   output_path â€” è¾“å‡ºè·¯å¾„ (å¯é€‰, è‡ªåŠ¨ç”Ÿæˆ)

// === Step 1: ç¡®å®šå‚æ•° ===
let device_idx = if device != () { parse_int(device) } else { 0 };
let img_format = if format != () { format } else { "jpg" };

log("ğŸ“· [æ‹ç…§] å¼€å§‹æ‹ç…§æµç¨‹");
log("ğŸ“· [æ‹ç…§] è®¾å¤‡: " + device_idx + ", æ ¼å¼: " + img_format);

// === Step 2: è·å–æ‘„åƒå¤´ä¿¡æ¯ ===
let info = call_tool("camera_capture", #{
    action: "info"
});

if is_error(info) {
    log_warn("ğŸ“· [æ‹ç…§] æ— æ³•è·å–æ‘„åƒå¤´ä¿¡æ¯ï¼Œå°è¯•ç›´æ¥æ‹ç…§");
}

// === Step 3: æ‰§è¡Œæ‹ç…§ ===
let capture_params = #{
    action: "capture",
    device_index: device_idx,
    format: img_format
};

// å¦‚æœç”¨æˆ·æŒ‡å®šäº†è¾“å‡ºè·¯å¾„ï¼ŒåŠ å…¥å‚æ•°
if output_path != () && output_path != "" {
    capture_params.output_path = output_path;
}

log("ğŸ“· [æ‹ç…§] æ­£åœ¨æ‹æ‘„...");
let result = call_tool("camera_capture", capture_params);

// === Step 4: å¤„ç†ç»“æœ ===
if is_error(result) {
    let error_msg = get_field(result, "error");
    log_warn("ğŸ“· [æ‹ç…§] æ‹ç…§å¤±è´¥: " + error_msg);
    
    // é™çº§ç­–ç•¥: å¦‚æœæ‘„åƒå¤´æ‹ç…§å¤±è´¥ï¼Œå°è¯•æˆªå±
    log("ğŸ“· [æ‹ç…§] å°è¯•é™çº§ä¸ºæˆªå±...");
    let fallback_params = #{
        action: "capture",
        device_index: 0
    };
    let fallback = call_tool("camera_capture", fallback_params);
    
    if is_error(fallback) {
        set_output(#{
            success: false,
            error: "æ‹ç…§å¤±è´¥ï¼Œæ‰€æœ‰æ–¹å¼å‡ä¸å¯ç”¨",
            suggestion: "è¯·å®‰è£… ffmpeg: brew install ffmpeg",
            original_error: error_msg
        });
    } else {
        let path = get_field(fallback, "path");
        let method = get_field(fallback, "method");
        let size = get_field(fallback, "file_size_bytes");
        let note = get_field(fallback, "note");
        
        set_output(#{
            success: true,
            path: path,
            method: method,
            file_size_bytes: size,
            degraded: true,
            note: if note != () { note } else { "ä½¿ç”¨äº†é™çº§æ–¹å¼æ‹æ‘„" }
        });
    }
} else {
    let path = get_field(result, "path");
    let method = get_field(result, "method");
    let size = get_field(result, "file_size_bytes");
    let resolution = get_field(result, "resolution");
    
    log("ğŸ“· [æ‹ç…§] æ‹ç…§æˆåŠŸ: " + path);
    
    set_output(#{
        success: true,
        path: path,
        method: method,
        file_size_bytes: size,
        resolution: if resolution != () { resolution } else { "unknown" },
        degraded: false
    });
}
