// weather skill â€” ç›´æ¥è®¿é—® wttr.in å…è´¹å¤©æ°”APIè·å–å®æ—¶å¤©æ°”å’Œé¢„æŠ¥
// é›¶ API Keyï¼Œå…¨çƒè¦†ç›–ï¼Œæ”¯æŒä¸­æ–‡åŸå¸‚å

let input = ctx.user_input;

// 1. æå–åŸå¸‚å
// å¸¸è§ä¸­æ–‡åŸå¸‚ â†’ è‹±æ–‡æ˜ å°„ï¼ˆwttr.in ä¹Ÿæ”¯æŒä¸­æ–‡ä½†è‹±æ–‡æ›´ç¨³å®šï¼‰
let city_map = #{
    "åŒ—äº¬": "Beijing",
    "ä¸Šæµ·": "Shanghai",
    "æ·±åœ³": "Shenzhen",
    "å¹¿å·": "Guangzhou",
    "æˆéƒ½": "Chengdu",
    "æ­å·": "Hangzhou",
    "æ­¦æ±‰": "Wuhan",
    "å—äº¬": "Nanjing",
    "è¥¿å®‰": "Xian",
    "é‡åº†": "Chongqing",
    "è‹å·": "Suzhou",
    "å¤©æ´¥": "Tianjin",
    "é•¿æ²™": "Changsha",
    "éƒ‘å·": "Zhengzhou",
    "é’å²›": "Qingdao",
    "å¤§è¿": "Dalian",
    "å®æ³¢": "Ningbo",
    "å¦é—¨": "Xiamen",
    "æµå—": "Jinan",
    "åˆè‚¥": "Hefei",
    "ç¦å·": "Fuzhou",
    "æ˜†æ˜": "Kunming",
    "å“ˆå°”æ»¨": "Harbin",
    "æ²ˆé˜³": "Shenyang",
    "é•¿æ˜¥": "Changchun",
    "å¤ªåŸ": "Taiyuan",
    "çŸ³å®¶åº„": "Shijiazhuang",
    "å—æ˜Œ": "Nanchang",
    "è´µé˜³": "Guiyang",
    "æµ·å£": "Haikou",
    "ä¸‰äºš": "Sanya",
    "ä¹Œé²æœ¨é½": "Urumqi",
    "å…°å·": "Lanzhou",
    "é“¶å·": "Yinchuan",
    "è¥¿å®": "Xining",
    "å‘¼å’Œæµ©ç‰¹": "Hohhot",
    "é¦™æ¸¯": "Hong+Kong",
    "æ¾³é—¨": "Macau",
    "å°åŒ—": "Taipei",
    "å°æ¹¾": "Taiwan"
};

// è¯†åˆ«åŸå¸‚ï¼ˆç®€å•æå–ï¼šå»æ‰å¸¸è§è¯åå‰©ä½™éƒ¨åˆ†ï¼‰
let city_raw = "";

// å…ˆå°è¯•ä» city_map ä¸­åŒ¹é…
for key in city_map.keys() {
    if input.contains(key) {
        city_raw = city_map[key];
        break;
    }
}

// å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•ä»è¾“å…¥é‡Œæå–åŸå¸‚å
// å¸¸è§å¥å¼: "åŒ—äº¬å¤©æ°”", "æŸ¥ä¸‹ä¸Šæµ·å¤©æ°”", "xxå¤©æ°”æ€ä¹ˆæ ·"
if city_raw == "" {
    // ç§»é™¤å¸¸è§å¹²æ‰°è¯ï¼Œå‰©ä½™éƒ¨åˆ†å¯èƒ½æ˜¯åŸå¸‚å
    let clean = input;
    clean = clean.replace("å¤©æ°”", "");
    clean = clean.replace("é¢„æŠ¥", "");
    clean = clean.replace("æŸ¥", "");
    clean = clean.replace("æŸ¥è¯¢", "");
    clean = clean.replace("æŸ¥ä¸‹", "");
    clean = clean.replace("ä»Šå¤©", "");
    clean = clean.replace("æ˜å¤©", "");
    clean = clean.replace("åå¤©", "");
    clean = clean.replace("ä¸€å‘¨", "");
    clean = clean.replace("7å¤©", "");
    clean = clean.replace("æ€ä¹ˆæ ·", "");
    clean = clean.replace("å¦‚ä½•", "");
    clean = clean.replace("ï¼Ÿ", "");
    clean = clean.replace("?", "");
    clean = clean.trim();

    if clean.len() > 0 && clean.len() <= 10 {
        city_raw = clean;
    }
}

// é»˜è®¤åŸå¸‚
if city_raw == "" {
    city_raw = "Beijing";
}

// URL ç¼–ç ï¼ˆç©ºæ ¼è½¬+ï¼‰
let city_encoded = city_raw.replace(" ", "+");

// 2. è¯†åˆ«æŸ¥è¯¢åœºæ™¯
let want_aqi    = input.contains("ç©ºæ°”") || input.contains("AQI") || input.contains("PM2.5") || input.contains("pm2.5");
let want_week   = input.contains("ä¸€å‘¨") || input.contains("7å¤©") || input.contains("å‘¨") || input.contains("æœªæ¥");
let want_advice = input.contains("å¸¦ä¼") || input.contains("ç©¿") || input.contains("å‡ºè¡Œ") || input.contains("å»ºè®®");

// 3. æŠ“å– wttr.in JSONï¼ˆé¦–é€‰ï¼Œå«å½“å‰å¤©æ°”+3å¤©é¢„æŠ¥ï¼‰
let wttr_url = "https://wttr.in/" + city_encoded + "?format=j1";
let weather_data = call_tool("web_fetch", #{
    url: wttr_url,
    extractMode: "raw",
    maxChars: 20000
});

let got_json = false;
let weather_text = "";

if weather_data.is_map() && weather_data["text"] != () {
    weather_text = weather_data["text"].to_string();
    // ç®€å•åˆ¤æ–­æ˜¯å¦æ˜¯ JSONï¼ˆä»¥ { å¼€å¤´ï¼‰
    if weather_text.trim().starts_with("{") {
        got_json = true;
    }
}

// 4. å¦‚æœ JSON å¤±è´¥ï¼Œå›é€€åˆ°æ–‡æœ¬æ ¼å¼
if !got_json || weather_text.len() < 100 {
    let fallback_url = "https://wttr.in/" + city_encoded + "?lang=zh&format=4";
    let fallback_data = call_tool("web_fetch", #{
        url: fallback_url,
        extractMode: "raw",
        maxChars: 5000
    });

    if fallback_data.is_map() && fallback_data["text"] != () {
        let fb_text = fallback_data["text"].to_string();
        if fb_text.len() > 20 {
            // æ–‡æœ¬æ ¼å¼æˆåŠŸ
            return #{
                success: true,
                city: city_raw,
                source: "wttr.in (text)",
                format: "text",
                data: fb_text,
                instruction: "ä»¥ä¸‹æ˜¯åŸå¸‚ " + city_raw + " çš„å¤©æ°”æ•°æ®ï¼ˆæ–‡æœ¬æ ¼å¼ï¼‰ã€‚è¯·è§£æå¹¶ä»¥å‹å¥½æ ¼å¼å±•ç¤ºå¤©æ°”ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼šå½“å‰æ°”æ¸©ã€å¤©æ°”çŠ¶å†µã€æœ€é«˜/æœ€ä½æ¸©ã€‚å¦‚æœç”¨æˆ·è¯¢é—®å‡ºè¡Œå»ºè®®ï¼ˆå¸¦ä¼/ç©¿è¡£ï¼‰ï¼Œæ ¹æ®å¤©æ°”çŠ¶å†µç»™å‡ºå®ç”¨å»ºè®®ã€‚æ ¼å¼ï¼š\nğŸŒ¤ï¸ {åŸå¸‚} å¤©æ°”\nå½“å‰ï¼š{å¤©æ°”} {æ¸©åº¦}Â°C\næœ€é«˜/æœ€ä½ï¼š{max}/{min}Â°C\nğŸ’¡ å»ºè®®ï¼š{æ ¹æ®å¤©æ°”ç»™å‡ºç©¿è¡£å¸¦ä¼å»ºè®®}"
            }
        }
    }

    // å…¨éƒ¨å¤±è´¥
    return #{
        success: false,
        city: city_raw,
        error: "æ— æ³•è·å– " + city_raw + " çš„å¤©æ°”æ•°æ®ï¼Œè¯·æ£€æŸ¥åŸå¸‚åæ˜¯å¦æ­£ç¡®ï¼Œæˆ–ç¨åé‡è¯•ã€‚",
        instruction: "å‘ŠçŸ¥ç”¨æˆ·æ— æ³•è·å–å¤©æ°”æ•°æ®ã€‚å¦‚æœåŸå¸‚åæ˜¯ä¸­æ–‡ï¼Œå»ºè®®æä¾›æ‹¼éŸ³æˆ–è‹±æ–‡åŸå¸‚åé‡è¯•ã€‚"
    }
}

// 5. å¦‚æœéœ€è¦ AQIï¼Œé¢å¤–æŠ“å–
let aqi_data = "";
if want_aqi {
    let aqi_city = city_raw.replace("+", "-").to_lower();
    let aqi_url = "https://aqicn.org/city/" + aqi_city + "/";
    let aqi_result = call_tool("web_fetch", #{
        url: aqi_url,
        extractMode: "markdown",
        maxChars: 5000
    });
    if aqi_result.is_map() && aqi_result["text"] != () {
        aqi_data = aqi_result["text"].to_string();
    }
}

// 6. è¿”å›æ•°æ®ç»™ LLM å¤„ç†
let instruction = "ä»¥ä¸‹æ˜¯åŸå¸‚ \"" + city_raw + "\" çš„ wttr.in JSON å¤©æ°”æ•°æ®ã€‚è¯·è§£æ JSON å¹¶æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š\n\n";
instruction += "ğŸŒ¤ï¸ {åŸå¸‚} å¤©æ°” â€” {å½“å‰æ—¥æœŸæ—¶é—´}\n";
instruction += "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n";
instruction += "â˜€ï¸ å½“å‰å¤©æ°”\n";
instruction += "  å¤©æ°”ï¼š{weatherDesc} | æ°”æ¸©ï¼š{temp_C}Â°Cï¼ˆä½“æ„Ÿ {FeelsLikeC}Â°Cï¼‰\n";
instruction += "  æ¹¿åº¦ï¼š{humidity}% | é£é€Ÿï¼š{windspeedKmph}km/h {winddir16Point}\n";
instruction += "  èƒ½è§åº¦ï¼š{visibility}km | ç´«å¤–çº¿ï¼š{uvIndex} | æ°”å‹ï¼š{pressure}hPa\n\n";
instruction += "ğŸ“… æœªæ¥3å¤©é¢„æŠ¥\n";
instruction += "  ä»Šå¤©({date})ï¼š{å¤©æ°”æè¿°} æœ€ä½{mintempC}Â°C ~ æœ€é«˜{maxtempC}Â°C\n";
instruction += "  æ˜å¤©({date})ï¼š...\n";
instruction += "  åå¤©({date})ï¼š...\n\n";
instruction += "ğŸ’¡ å‡ºè¡Œå»ºè®®ï¼ˆåŸºäºä»¥ä¸‹è§„åˆ™ï¼‰ï¼š\n";
instruction += "  - æ°”æ¸©<10Â°C â†’ ç©¿åšå¤–å¥—\n";
instruction += "  - æ°”æ¸©10-20Â°C â†’ è–„å¤–å¥—/é•¿è¢–\n";
instruction += "  - æ°”æ¸©>30Â°C â†’ æ¸…å‡‰è¡£ç‰©ï¼Œæ³¨æ„é˜²æš‘\n";
instruction += "  - æœ‰é›¨(Rain/Drizzle/Shower) â†’ å»ºè®®å¸¦ä¼\n";
instruction += "  - æœ‰é›ª(Snow) â†’ é˜²æ»‘ä¿æš–\n";
instruction += "  - ç´«å¤–çº¿>5 â†’ å»ºè®®é˜²æ™’\n";
instruction += "  - é£é€Ÿ>40km/h â†’ æ³¨æ„å¤§é£\n";

if aqi_data.len() > 50 {
    instruction += "\n\nå¦é™„ç©ºæ°”è´¨é‡æ•°æ®ï¼ˆæ¥è‡ª aqicn.orgï¼‰ï¼š\n" + aqi_data + "\nè¯·åŒæ—¶å±•ç¤º AQI å’Œ PM2.5 ä¿¡æ¯ã€‚";
}

return #{
    success: true,
    city: city_raw,
    source: "wttr.in",
    format: "json",
    data: weather_text,
    aqi: aqi_data,
    instruction: instruction
}
